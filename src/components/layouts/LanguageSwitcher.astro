---
import clsx from "clsx";
import Button from "@/components/ui/Button.astro";
import Icon from "@/components/ui/Icon.astro";
import {
  type Locale,
  LOCALES,
  getLocaleDisplayName,
  getLocalizedUrl,
  getLocaleFromPath,
} from "@/utils/i18n";

export interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;

const currentPath = Astro.url.pathname;
const base = import.meta.env.BASE_URL.replace(/\/$/, "");
const currentLocale = getLocaleFromPath(currentPath);

// Get the path without base and locale prefix
const pathWithoutBase = currentPath.replace(new RegExp(`^${base}`), "");
const pathWithoutLocale = pathWithoutBase.replace(/^\/(ja|en|zh)/, "") || "/";

// Short locale codes for display
const shortLocale: Record<Locale, string> = {
  ja: "JP",
  en: "EN",
  zh: "ZH",
};

const dropdownStyles = clsx(
  "absolute right-0 top-full mt-2",
  "min-w-[120px]",
  "bg-surface border border-muted/20",
  "shadow-lg",
  "z-50",
);
---

<div class="relative" id="lang-switcher">
  <Button
    variant="outline"
    size="icon"
    id="lang-switcher-btn"
    aria-label="Switch language"
    aria-expanded="false"
    aria-haspopup="listbox"
    class={clsx("font-mono text-xs neon-cyan", className)}
  >
    <span>{shortLocale[currentLocale]}</span>
  </Button>

  <div class={dropdownStyles} id="lang-dropdown" hidden>
    {
      LOCALES.map((locale) => {
        const isActive = locale === currentLocale;
        return (
          <a
            href={getLocalizedUrl(pathWithoutLocale, locale)}
            class={clsx(
              "flex w-full items-center justify-between px-4 py-3",
              "font-mono text-xs uppercase",
              "transition-colors",
              isActive ? "neon-cyan bg-cyan-10 border-l-cyan border-l-2" : "text-gray hover-white",
            )}
            data-locale={locale}
          >
            <span>{getLocaleDisplayName(locale)}</span>
            {isActive && <Icon name="check" size={12} />}
          </a>
        );
      })
    }
  </div>
</div>

<script is:inline>
  (function () {
    function initLangSwitcher() {
      const btn = document.getElementById("lang-switcher-btn");
      const dropdown = document.getElementById("lang-dropdown");
      const container = document.getElementById("lang-switcher");

      if (!btn || !dropdown || !container) return;

      // Prevent duplicate event listeners
      if (btn.dataset.initialized) return;
      btn.dataset.initialized = "true";

      function open() {
        dropdown.hidden = false;
        btn.setAttribute("aria-expanded", "true");
      }

      function close() {
        dropdown.hidden = true;
        btn.setAttribute("aria-expanded", "false");
      }

      function toggle() {
        if (dropdown.hidden) {
          open();
        } else {
          close();
        }
      }

      // Toggle on click/touch
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggle();
      });

      // Close when clicking outside
      document.addEventListener("click", (e) => {
        if (!container.contains(e.target)) {
          close();
        }
      });

      // Close on escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !dropdown.hidden) {
          close();
          btn.focus();
        }
      });
    }

    // Initialize
    initLangSwitcher();

    // Re-initialize after page transitions
    document.addEventListener("astro:page-load", initLangSwitcher);
  })();
</script>
